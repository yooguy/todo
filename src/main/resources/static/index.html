<!DOCTYPE html>
<html lang="en" x-data="todoApp()" class="bg-gray-50 min-h-screen p-8">
<head>
  <meta charset="UTF-8">
  <title>Modern To-do List Dashboard</title>

  <!-- Shoelace -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/shoelace.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.16.0/cdn/themes/light.css">

  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.13.0" defer></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS (xlsx ÎùºÏù¥Î∏åÎü¨Î¶¨) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
</head>

<body class="font-sans">

<div class="max-w-5xl mx-auto" x-init="fetchTodos()">

  <!-- Ìó§Îçî -->
  <div class="flex items-center gap-3 mb-8">
    <img src="https://emojicdn.elk.sh/üìù" class="w-10 h-10">
    <h1 class="text-3xl font-bold">To-do List</h1>
  </div>

  <!-- ÏûÖÎ†• Ìèº -->
  <div class="flex flex-wrap gap-2 items-center mb-6">
    <sl-input placeholder="New task..." class="flex-1 min-w-[150px]" x-model="newTask"></sl-input>
    <sl-input type="date" label="Start Date" class="flex-1 min-w-[150px]" x-model="startDate"></sl-input>
    <sl-input type="date" label="End Date" class="flex-1 min-w-[150px]" x-model="endDate"></sl-input>

    <div class="flex gap-2">
      <sl-button variant="primary" size="small" @click="createTodo()" :disabled="newTask.length === 0">
        ‚ûï Add
      </sl-button>
      <sl-button variant="success" size="small" @click="downloadExcel()">
        üì• Download
      </sl-button>
    </div>
  </div>

  <!-- Todo Î¶¨Ïä§Ìä∏ ÌÖåÏù¥Î∏î -->
  <sl-card class="rounded-lg shadow p-6 bg-white">
    <table class="w-full text-sm table-auto">
      <thead class="bg-gray-100 text-gray-700">
      <tr>
        <th class="px-4 py-3 text-left">Task</th>
        <th class="px-4 py-3 text-center">Start Date</th>
        <th class="px-4 py-3 text-center">End Date</th>
        <th class="px-4 py-3 text-center">Status</th>
        <th class="px-4 py-3 text-center">Toggle</th>
        <th class="px-4 py-3 text-center">Actions</th>
      </tr>
      </thead>
      <tbody>
      <template x-for="todo in todos" :key="todo.id">
        <tr class="border-b">
          <td class="px-4 py-3" :class="todo.completed ? 'text-gray-400 line-through' : ''" x-text="todo.title"></td>
          <td class="px-4 py-3 text-center" x-text="todo.startDate || '-'"></td>
          <td class="px-4 py-3 text-center" x-text="todo.endDate || '-'"></td>
          <td class="px-4 py-3 text-center">
            <sl-tag size="small" :variant="todo.completed ? 'success' : 'warning'">
              <span x-text="todo.completed ? 'Completed' : 'Pending'"></span>
            </sl-tag>
          </td>
          <td class="px-4 py-3 text-center">
            <sl-switch :checked="todo.completed" @sl-change="toggleTodo(todo.id)" class="scale-90"></sl-switch>
          </td>
          <td class="px-4 py-3 text-center">
            <sl-button variant="danger" size="small" @click="confirmDelete(todo.id)">
              üóëÔ∏è
            </sl-button>
          </td>
        </tr>
      </template>

      <tr x-show="todos.length === 0">
        <td colspan="6" class="text-center text-gray-400 py-6">
          No tasks yet. Add a new task!
        </td>
      </tr>
      </tbody>
    </table>
  </sl-card>

  <!-- ÏÇ≠Ï†ú ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
  <sl-dialog label="Confirm Delete" class="dialog-delete" x-ref="deleteDialog">
    <p>Are you sure you want to delete this task?</p>
    <div slot="footer" class="flex justify-end gap-2">
      <sl-button @click="$refs.deleteDialog.hide()">Cancel</sl-button>
      <sl-button variant="danger" @click="deleteConfirmed()">
        Delete
      </sl-button>
    </div>
  </sl-dialog>

</div>

<script>
  function todoApp() {
    return {
      todos: [],
      newTask: '',
      startDate: '',
      endDate: '',
      todoIdToDelete: null,

      async fetchTodos() {
        const res = await fetch('/api/todos');
        this.todos = await res.json();
      },

      async createTodo() {
        const res = await fetch('/api/todos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: this.newTask,
            startDate: this.startDate || null,
            endDate: this.endDate || null
          })
        });

        if (res.ok) {
          this.newTask = '';
          this.startDate = '';
          this.endDate = '';
          await this.fetchTodos();
        }
      },

      async toggleTodo(id) {
        const res = await fetch(`/api/todos/${id}/toggle`, { method: 'PATCH' });
        if (res.ok) {
          await this.fetchTodos();
        }
      },

      confirmDelete(id) {
        this.todoIdToDelete = id;
        this.$refs.deleteDialog.show();
      },

      async deleteConfirmed() {
        if (this.todoIdToDelete !== null) {
          const res = await fetch(`/api/todos/${this.todoIdToDelete}`, { method: 'DELETE' });
          if (res.ok) {
            await this.fetchTodos();
          }
          this.todoIdToDelete = null;
          this.$refs.deleteDialog.hide();
        }
      },

      downloadExcel() {
        const worksheetData = this.todos.map(todo => ({
          Title: todo.title,
          StartDate: todo.startDate || '-',
          EndDate: todo.endDate || '-',
          Status: todo.completed ? 'Completed' : 'Pending'
        }));

        const worksheet = XLSX.utils.json_to_sheet(worksheetData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Todos');

        XLSX.writeFile(workbook, 'todo-list.xlsx');
      }
    }
  }
</script>

</body>
</html>
