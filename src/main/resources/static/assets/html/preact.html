<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Todo List - Preact + Tailwind</title>

    <!-- Tailwind CSS -->
    <link href="/libs/tailwind/tailwind.min.css" rel="stylesheet">

    <!-- Preact -->
    <script type="module">
        import { h, render } from 'https://esm.sh/preact@10.19.2';
        import { useState, useEffect } from 'https://esm.sh/preact@10.19.2/hooks';
        import ExcelJS from '/libs/exceljs/exceljs.min.js';

        function App() {
            const [todos, setTodos] = useState([]);
            const [newTask, setNewTask] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [deleteId, setDeleteId] = useState(null);

            useEffect(() => {
                fetchTodos();
            }, []);

            async function fetchTodos() {
                try {
                    const res = await fetch('/api/todos');
                    if (res.ok) {
                        setTodos(await res.json());
                    }
                } catch (error) {
                    console.error('Failed to fetch todos:', error);
                }
            }

            async function createTodo(e) {
                e.preventDefault();
                const todoData = { title: newTask, startDate, endDate };
                try {
                    const res = await fetch('/api/todos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(todoData)
                    });
                    if (res.ok) {
                        setNewTask('');
                        setStartDate('');
                        setEndDate('');
                        fetchTodos();
                    }
                } catch (error) {
                    console.error('Failed to create todo:', error);
                }
            }

            async function toggleTodo(id) {
                try {
                    const res = await fetch(`/api/todos/${id}/toggle`, { method: 'PATCH' });
                    if (res.ok) {
                        fetchTodos();
                    }
                } catch (error) {
                    console.error('Failed to toggle todo:', error);
                }
            }

            async function confirmDelete() {
                if (!deleteId) return;
                try {
                    const res = await fetch(`/api/todos/${deleteId}`, { method: 'DELETE' });
                    if (res.ok) {
                        setDeleteId(null);
                        fetchTodos();
                    }
                } catch (error) {
                    console.error('Failed to delete todo:', error);
                }
            }

            function downloadExcel() {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Todos');
                worksheet.columns = [
                    { header: 'ì‘ì—…', key: 'title' },
                    { header: 'ì‹œì‘ì¼', key: 'startDate' },
                    { header: 'ë§ˆê°ì¼', key: 'endDate' },
                    { header: 'ìƒíƒœ', key: 'status' }
                ];

                todos.forEach(todo => {
                    worksheet.addRow({
                        title: todo.title,
                        startDate: todo.startDate,
                        endDate: todo.endDate,
                        status: todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'
                    });
                });

                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'todo-list.xlsx';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }

            return (
                <div class="max-w-5xl mx-auto space-y-10 animate-fade-in p-10 min-h-screen bg-gradient-to-br from-slate-100 to-white">

                    {/* Header */}
                    <div class="flex items-center justify-between">
                        <h1 class="text-4xl font-extrabold text-slate-800 drop-shadow">ğŸ“‹ To-do List</h1>
                        <button onClick={downloadExcel} class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white shadow">
                            ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>

                    {/* Form */}
                    <form onSubmit={createTodo} class="bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200 p-6 flex flex-wrap items-center gap-4">
                        <input
                            value={newTask}
                            onInput={e => setNewTask(e.target.value)}
                            type="text"
                            placeholder="New task..."
                            class="flex-1 min-w-[180px] p-2 rounded-lg border"
                            required
                        />
                        <input
                            value={startDate}
                            onInput={e => setStartDate(e.target.value)}
                            type="date"
                            class="flex-1 min-w-[150px] p-2 rounded-lg border"
                        />
                        <input
                            value={endDate}
                            onInput={e => setEndDate(e.target.value)}
                            type="date"
                            class="flex-1 min-w-[150px] p-2 rounded-lg border"
                        />
                        <button
                            type="submit"
                            class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white shadow"
                            disabled={!newTask.trim()}
                        >
                            â• ì¶”ê°€
                        </button>
                    </form>

                    {/* Table */}
                    <div class="overflow-x-auto bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200">
                        <table class="w-full text-sm table-auto">
                            <thead class="bg-slate-100 text-slate-700">
                            <tr>
                                <th class="p-4 text-left">ì‘ì—…</th>
                                <th class="p-4 text-center">ì‹œì‘ì¼</th>
                                <th class="p-4 text-center">ë§ˆê°ì¼</th>
                                <th class="p-4 text-center">ìƒíƒœ</th>
                                <th class="p-4 text-center">í† ê¸€</th>
                                <th class="p-4 text-center">ì‚­ì œ</th>
                            </tr>
                            </thead>
                            <tbody>
                            {todos.length === 0 ? (
                                <tr>
                                    <td colspan="6" class="p-8 text-center text-slate-400">ğŸ“ ì•„ì§ ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                                </tr>
                            ) : (
                                todos.map(todo => (
                                    <tr class="border-t hover:bg-slate-50 transition" key={todo.id}>
                                        <td class={`p-4 ${todo.completed ? 'line-through text-gray-400' : 'text-slate-800'}`}>{todo.title}</td>
                                        <td class="p-4 text-center">{todo.startDate || '-'}</td>
                                        <td class="p-4 text-center">{todo.endDate || '-'}</td>
                                        <td class="p-4 text-center">
                        <span class={todo.completed ? 'text-green-600' : 'text-yellow-500'}>
                          {todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'}
                        </span>
                                        </td>
                                        <td class="p-4 text-center">
                                            <input
                                                type="checkbox"
                                                checked={todo.completed}
                                                onChange={() => toggleTodo(todo.id)}
                                            />
                                        </td>
                                        <td class="p-4 text-center">
                                            <button
                                                class="text-red-500 hover:underline"
                                                onClick={() => setDeleteId(todo.id)}
                                            >
                                                ğŸ—‘ï¸
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            )}
                            </tbody>
                        </table>
                    </div>

                    {/* Delete Modal */}
                    {deleteId && (
                        <div class="fixed inset-0 flex items-center justify-center bg-black/30">
                            <div class="bg-white p-8 rounded-xl shadow-2xl space-y-6 w-80">
                                <h2 class="text-xl font-bold text-center">ì‚­ì œ í™•ì¸</h2>
                                <p class="text-center text-slate-600">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                                <div class="flex justify-around">
                                    <button onClick={() => setDeleteId(null)} class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded">
                                        ì·¨ì†Œ
                                    </button>
                                    <button onClick={confirmDelete} class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">
                                        ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        render(h(App), document.body);
    </script>

    <style>
        html { scroll-behavior: smooth; }
        @keyframes fade-in {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
    </style>
</head>

<body></body>
</html>