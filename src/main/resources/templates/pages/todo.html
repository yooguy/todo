<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Todo List - Tailwind 4 + 3D</title>
    <link href="/vendors/tailwind/tailwind.min.css" rel="stylesheet">
    <script src="/vendors/alpinejs/alpine.min.js" defer></script>
    <script src="/vendors/exceljs/exceljs.min.js" defer></script>
    <script src="/vendors/shoelace-style/shoelace-autoloader.js" type="module"></script>

    <style>
        html { scroll-behavior: smooth; }
        /* ê°„ë‹¨í•œ fade in ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fade-in {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-100 to-white p-10">

<div x-data="todoApp()" class="max-w-5xl mx-auto space-y-10 animate-fade-in">

    <!-- ğŸ·ï¸ í—¤ë” -->
    <div class="flex items-center justify-between">
        <h1 class="text-4xl font-extrabold text-slate-800 drop-shadow">ğŸ“‹ To-do List</h1>
        <sl-button variant="success" size="small" @click="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</sl-button>
    </div>

    <!-- ğŸ“ ì…ë ¥ í¼ -->
    <div class="bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200 p-6 flex flex-wrap items-center gap-4 hover:scale-105 hover:shadow-3xl transition-all duration-300">
        <sl-input placeholder="New task..." class="flex-1 min-w-[180px]" x-model="newTask"></sl-input>
        <sl-input type="date" class="flex-1 min-w-[150px]" x-model="startDate"></sl-input>
        <sl-input type="date" class="flex-1 min-w-[150px]" x-model="endDate"></sl-input>
        <sl-button variant="primary" size="small" @click="createTodo()" :disabled="newTask.length === 0">â• ì¶”ê°€</sl-button>
    </div>

    <!-- ğŸ“‹ To-do ë¦¬ìŠ¤íŠ¸ -->
    <div class="overflow-x-auto bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200 hover:shadow-3xl transition-all duration-300">
        <table class="w-full text-sm table-auto">
            <thead class="bg-slate-100 text-slate-700 text-base">
            <tr>
                <th class="p-4 text-left">ì‘ì—…</th>
                <th class="p-4 text-center">ì‹œì‘ì¼</th>
                <th class="p-4 text-center">ë§ˆê°ì¼</th>
                <th class="p-4 text-center">ìƒíƒœ</th>
                <th class="p-4 text-center">í† ê¸€</th>
                <th class="p-4 text-center">ì‚­ì œ</th>
            </tr>
            </thead>

            <tbody>
            <template x-for="todo in todos" :key="todo.id">
                <tr class="border-t transition hover:bg-slate-50 hover:scale-[1.01]">
                    <td class="p-4" :class="todo.completed ? 'text-slate-400 line-through' : 'text-slate-800'" x-text="todo.title"></td>
                    <td class="p-4 text-center" x-text="todo.startDate || '-'"></td>
                    <td class="p-4 text-center" x-text="todo.endDate || '-'"></td>
                    <td class="p-4 text-center">
                        <sl-tag size="small" :variant="todo.completed ? 'success' : 'warning'">
                            <span x-text="todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'"></span>
                        </sl-tag>
                    </td>
                    <td class="p-4 text-center">
                        <sl-switch :checked="todo.completed" @sl-change="toggleTodo(todo.id)"></sl-switch>
                    </td>
                    <td class="p-4 text-center">
                        <sl-button variant="danger" size="small" @click="confirmDelete(todo.id)">ğŸ—‘ï¸</sl-button>
                    </td>
                </tr>
            </template>

            <tr x-show="todos.length === 0">
                <td colspan="6" class="p-8 text-center text-slate-400">ğŸ“ ì•„ì§ ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- ğŸ—‘ï¸ ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <sl-dialog label="ì‚­ì œ í™•ì¸" class="dialog-delete" x-ref="deleteDialog">
        <p class="text-center py-6 text-lg">ì •ë§ ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div slot="footer" class="flex justify-end gap-4">
            <sl-button @click="$refs.deleteDialog.hide()">ì·¨ì†Œ</sl-button>
            <sl-button variant="danger" @click="deleteConfirmed()">ì‚­ì œ</sl-button>
        </div>
    </sl-dialog>

</div>

<script>
    function todoApp() {
        return {
            todos: [],
            newTask: '',
            startDate: '',
            endDate: '',
            todoIdToDelete: null,

            async fetchTodos() {
                const res = await fetch('/api/todos');
                if (res.ok) {
                    this.todos = await res.json();
                }
            },

            async createTodo() {
                if (!this.newTask.trim()) return;
                const res = await fetch('/api/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.newTask,
                        startDate: this.startDate || null,
                        endDate: this.endDate || null
                    })
                });
                if (res.ok) {
                    this.newTask = '';
                    this.startDate = '';
                    this.endDate = '';
                    await this.fetchTodos();
                }
            },

            async toggleTodo(id) {
                const res = await fetch(`/api/todos/${id}/toggle`, { method: 'PATCH' });
                if (res.ok) {
                    await this.fetchTodos();
                }
            },

            confirmDelete(id) {
                this.todoIdToDelete = id;
                this.$refs.deleteDialog.show();
            },

            async deleteConfirmed() {
                if (this.todoIdToDelete !== null) {
                    const res = await fetch(`/api/todos/${this.todoIdToDelete}`, { method: 'DELETE' });
                    if (res.ok) {
                        await this.fetchTodos();
                    }
                    this.todoIdToDelete = null;
                    this.$refs.deleteDialog.hide();
                }
            },

            downloadExcel() {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Todos');

                worksheet.columns = [
                    { header: 'ì‘ì—…', key: 'title', width: 40 },
                    { header: 'ì‹œì‘ì¼', key: 'startDate', width: 20 },
                    { header: 'ë§ˆê°ì¼', key: 'endDate', width: 20 },
                    { header: 'ìƒíƒœ', key: 'status', width: 15 }
                ];

                this.todos.forEach(todo => {
                    worksheet.addRow({
                        title: todo.title,
                        startDate: todo.startDate || '-',
                        endDate: todo.endDate || '-',
                        status: todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'
                    });
                });

                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'todo-list.xlsx';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            },

            async init() {
                await this.fetchTodos();
            }
        }
    }
</script>

</body>
</html>