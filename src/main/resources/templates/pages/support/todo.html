<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

<div x-data="todoApp()" class="space-y-6">

    <!-- í—¤ë” -->
    <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-slate-800">To-do List</h1>
        <sl-button variant="success" @click="downloadExcel()" size="small">
            ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        </sl-button>
    </div>

    <!-- ì…ë ¥ í¼ -->
    <div class="flex flex-wrap gap-4 items-center bg-white p-4 rounded-lg shadow border">
        <sl-input placeholder="New task..." class="flex-1 min-w-[150px]" x-model="newTask"></sl-input>
        <sl-input type="date" class="flex-1 min-w-[150px]" x-model="startDate"></sl-input>
        <sl-input type="date" class="flex-1 min-w-[150px]" x-model="endDate"></sl-input>

        <sl-button variant="primary" size="small" @click="createTodo()" :disabled="newTask.length === 0">
            â• ì¶”ê°€
        </sl-button>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ -->
    <div class="bg-white rounded-lg shadow border overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-slate-100 text-slate-700">
            <tr>
                <th class="p-3 text-left">ì‘ì—…</th>
                <th class="p-3 text-center">ì‹œì‘ì¼</th>
                <th class="p-3 text-center">ë§ˆê°ì¼</th>
                <th class="p-3 text-center">ìƒíƒœ</th>
                <th class="p-3 text-center">í† ê¸€</th>
                <th class="p-3 text-center">ì•¡ì…˜</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="todo in todos" :key="todo.id">
                <tr class="border-t hover:bg-slate-50 transition">
                    <td class="p-3" :class="todo.completed ? 'text-slate-400 line-through' : ''" x-text="todo.title"></td>
                    <td class="p-3 text-center" x-text="todo.startDate || '-'"></td>
                    <td class="p-3 text-center" x-text="todo.endDate || '-'"></td>
                    <td class="p-3 text-center">
                        <sl-tag size="small" :variant="todo.completed ? 'success' : 'warning'">
                            <span x-text="todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'"></span>
                        </sl-tag>
                    </td>
                    <td class="p-3 text-center">
                        <sl-switch :checked="todo.completed" @sl-change="toggleTodo(todo.id)"></sl-switch>
                    </td>
                    <td class="p-3 text-center">
                        <sl-button variant="danger" size="small" @click="confirmDelete(todo.id)">
                            ğŸ—‘ï¸
                        </sl-button>
                    </td>
                </tr>
            </template>

            <tr x-show="todos.length === 0">
                <td colspan="6" class="p-8 text-center text-slate-400">
                    ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì‘ì—…ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”!
                </td>
            </tr>

            </tbody>
        </table>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <sl-dialog label="ì‚­ì œ í™•ì¸" class="dialog-delete" x-ref="deleteDialog">
        <p class="text-center py-4">ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div slot="footer" class="flex justify-end gap-3">
            <sl-button @click="$refs.deleteDialog.hide()">ì·¨ì†Œ</sl-button>
            <sl-button variant="danger" @click="deleteConfirmed()">ì‚­ì œ</sl-button>
        </div>
    </sl-dialog>

</div>

<script>
    function todoApp() {
        return {
            todos: [],
            newTask: '',
            startDate: '',
            endDate: '',
            todoIdToDelete: null,

            async fetchTodos() {
                const res = await fetch('/api/todos');
                if (res.ok) {
                    this.todos = await res.json();
                }
            },

            async createTodo() {
                if (!this.newTask.trim()) return;
                const res = await fetch('/api/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: this.newTask,
                        startDate: this.startDate || null,
                        endDate: this.endDate || null
                    })
                });
                if (res.ok) {
                    this.newTask = '';
                    this.startDate = '';
                    this.endDate = '';
                    await this.fetchTodos();
                }
            },

            async toggleTodo(id) {
                const res = await fetch(`/api/todos/${id}/toggle`, { method: 'PATCH' });
                if (res.ok) {
                    await this.fetchTodos();
                }
            },

            confirmDelete(id) {
                this.todoIdToDelete = id;
                this.$refs.deleteDialog.show();
            },

            async deleteConfirmed() {
                if (this.todoIdToDelete !== null) {
                    const res = await fetch(`/api/todos/${this.todoIdToDelete}`, { method: 'DELETE' });
                    if (res.ok) {
                        await this.fetchTodos();
                    }
                    this.todoIdToDelete = null;
                    this.$refs.deleteDialog.hide();
                }
            },

            downloadExcel() {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Todos');

                worksheet.columns = [
                    { header: 'ì‘ì—…', key: 'title', width: 40 },
                    { header: 'ì‹œì‘ì¼', key: 'startDate', width: 20 },
                    { header: 'ë§ˆê°ì¼', key: 'endDate', width: 20 },
                    { header: 'ìƒíƒœ', key: 'status', width: 15 }
                ];

                this.todos.forEach(todo => {
                    worksheet.addRow({
                        title: todo.title,
                        startDate: todo.startDate || '-',
                        endDate: todo.endDate || '-',
                        status: todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'
                    });
                });

                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'todo-list.xlsx';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }
        }
    }
</script>

</body>
</html>