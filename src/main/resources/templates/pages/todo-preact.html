<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Todo List - Preact with Shoelace</title>

    <!-- Tailwind CSS -->
    <link href="/vendors/tailwind/tailwind.min.css" rel="stylesheet">

    <!-- Shoelace Components -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.4.0/dist/themes/light.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.4.0/dist/shoelace.js"></script>

    <!-- Preact -->
    <script src="https://unpkg.com/preact@10.15.1/dist/preact.min.js"></script>
    <script src="https://unpkg.com/preact@10.15.1/hooks/dist/hooks.umd.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.js"></script>

    <!-- ExcelJS -->
    <script src="/vendors/exceljs/exceljs.min.js"></script>

    <style>
        html { scroll-behavior: smooth; }
        @keyframes fade-in {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
        .modal {
            background: rgba(0,0,0,0.5);
        }
        [hidden] { display: none !important; }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-100 to-white p-10">
<div id="app" class="max-w-5xl mx-auto space-y-10 animate-fade-in"></div>

<script th:inline="javascript">
    // HTM with Preact setup
    const html = htm.bind(preact.h);
    const { h, render } = preact;
    const { useState, useEffect, useRef } = preactHooks;

    function TodoApp() {
        const [todos, setTodos] = useState([]);
        const [newTask, setNewTask] = useState('');
        const [startDate, setStartDate] = useState('');
        const [endDate, setEndDate] = useState('');
        const [todoIdToDelete, setTodoIdToDelete] = useState(null);
        const dialogRef = useRef(null);
        const formRef = useRef(null);

        const fetchTodos = async () => {
            try {
                const res = await fetch('/api/todos');
                if (res.ok) setTodos(await res.json());
            } catch (error) {
                console.error("Failed to fetch todos:", error);
                // ê°œë°œì„ ìœ„í•œ ì„ì‹œ ë°ì´í„°
                setTodos([
                    { id: 1, title: 'ìƒ˜í”Œ í• ì¼', completed: false, startDate: '2025-04-10', endDate: '2025-04-15' }
                ]);
            }
        };

        const createTodo = async (e) => {
            e.preventDefault();
            console.log("Creating todo:", newTask, startDate, endDate);

            if (!newTask.trim()) return;

            try {
                const res = await fetch('/api/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTask, startDate, endDate })
                });

                if (res.ok) {
                    setNewTask('');
                    setStartDate('');
                    setEndDate('');
                    await fetchTodos();
                }
            } catch (error) {
                console.error("Error creating todo:", error);

                // ê°œë°œì„ ìœ„í•œ ì„ì‹œ ì‘ë™
                const newTodo = {
                    id: Date.now(),
                    title: newTask,
                    startDate,
                    endDate,
                    completed: false
                };
                setTodos(prev => [...prev, newTodo]);
                setNewTask('');
                setStartDate('');
                setEndDate('');
            }
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            createTodo(e);
        };

        const updateTodo = async (id) => {
            try {
                const res = await fetch(`/api/todos/${id}/toggle`, { method: 'PATCH' });
                if (res.ok) await fetchTodos();
            } catch (error) {
                console.error("Error updating todo:", error);

                // ê°œë°œì„ ìœ„í•œ ì„ì‹œ ì‘ë™
                setTodos(prev => prev.map(todo =>
                    todo.id === id ? {...todo, completed: !todo.completed} : todo
                ));
            }
        };

        const deleteConfirmed = async () => {
            try {
                const res = await fetch(`/api/todos/${todoIdToDelete}`, { method: 'DELETE' });
                if (res.ok) {
                    await fetchTodos();
                }
            } catch (error) {
                console.error("Error deleting todo:", error);

                // ê°œë°œì„ ìœ„í•œ ì„ì‹œ ì‘ë™
                setTodos(prev => prev.filter(todo => todo.id !== todoIdToDelete));
            }

            setTodoIdToDelete(null);
            if (dialogRef.current) {
                dialogRef.current.hide();
            }
        };

        const downloadExcel = () => {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Todos');
            worksheet.columns = [
                { header: 'ì‘ì—…', key: 'title' },
                { header: 'ì‹œì‘ì¼', key: 'startDate' },
                { header: 'ë§ˆê°ì¼', key: 'endDate' },
                { header: 'ìƒíƒœ', key: 'status' }
            ];
            todos.forEach(todo => worksheet.addRow({
                title: todo.title,
                startDate: todo.startDate,
                endDate: todo.endDate,
                status: todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'
            }));
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'todo-list.xlsx';
                a.click();
                URL.revokeObjectURL(url);
            });
        };

        // ë‹¤ì´ì–¼ë¡œê·¸ ì²˜ë¦¬
        useEffect(() => {
            if (todoIdToDelete !== null && dialogRef.current) {
                dialogRef.current.show();
            }
        }, [todoIdToDelete]);

        useEffect(() => {
            fetchTodos();
        }, []);

        return html`
            <!-- í—¤ë” -->
            <div class="flex items-center justify-between">
                <h1 class="text-4xl font-extrabold text-slate-800 drop-shadow">ğŸ“‹ To-do List</h1>
                <sl-button variant="success" @click=${downloadExcel}>
                    ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </sl-button>
            </div>

            <!-- ì…ë ¥í¼ -->
            <form ref=${formRef} class="bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200 p-6 flex flex-wrap items-center gap-4">
                <sl-input
                        value=${newTask}
                        @sl-input=${(e) => setNewTask(e.target.value)}
                        placeholder="New task..."
                        class="flex-1 min-w-[180px]"
                        required
                ></sl-input>
                <sl-input
                        type="date"
                        value=${startDate}
                        @sl-input=${(e) => setStartDate(e.target.value)}
                        class="flex-1 min-w-[150px]"
                ></sl-input>
                <sl-input
                        type="date"
                        value=${endDate}
                        @sl-input=${(e) => setEndDate(e.target.value)}
                        class="flex-1 min-w-[150px]"
                ></sl-input>
                <sl-button type="button" variant="primary" disabled=${!newTask.trim().length} @click=${handleSubmit}>
                    â• ì¶”ê°€
                </sl-button>
            </form>

            <!-- To-do ë¦¬ìŠ¤íŠ¸ -->
            <div class="overflow-x-auto bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200">
                <table class="w-full text-sm table-auto">
                    <thead class="bg-slate-100 text-slate-700">
                    <tr>
                        <th class="p-4 text-left">ì‘ì—…</th>
                        <th class="p-4 text-center">ì‹œì‘ì¼</th>
                        <th class="p-4 text-center">ë§ˆê°ì¼</th>
                        <th class="p-4 text-center">ìƒíƒœ</th>
                        <th class="p-4 text-center">í† ê¸€</th>
                        <th class="p-4 text-center">ì‚­ì œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    ${todos.length === 0 ? html`
                        <tr>
                            <td colspan="6" class="p-8 text-center text-slate-400">
                                ğŸ“ ì•„ì§ ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.
                            </td>
                        </tr>
                    ` : todos.map(todo => html`
                        <tr key=${todo.id} class="border-t hover:bg-slate-50 transition">
                            <td class="p-4 ${todo.completed ? 'line-through text-gray-400' : ''}">
                                ${todo.title}
                            </td>
                            <td class="p-4 text-center">${todo.startDate || '-'}</td>
                            <td class="p-4 text-center">${todo.endDate || '-'}</td>
                            <td class="p-4 text-center">
                                        <span class=${todo.completed ? 'text-green-600' : 'text-yellow-500'}>
                                            ${todo.completed ? 'ì™„ë£Œ' : 'ì§„í–‰ ì¤‘'}
                                        </span>
                            </td>
                            <td class="p-4 text-center">
                                <sl-switch
                                        .checked=${todo.completed}
                                        @sl-change=${() => updateTodo(todo.id)}
                                ></sl-switch>
                            </td>
                            <td class="p-4 text-center">
                                <sl-icon-button
                                        name="trash"
                                        @click=${() => setTodoIdToDelete(todo.id)}
                                        class="text-red-500"
                                ></sl-icon-button>
                            </td>
                        </tr>
                    `)}
                    </tbody>
                </table>
            </div>

            <!-- ì‚­ì œ ëª¨ë‹¬ -->
            <sl-dialog ref=${dialogRef} label="ì‚­ì œ í™•ì¸" @sl-after-hide=${() => setTodoIdToDelete(null)}>
                <p class="text-center text-slate-600">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div slot="footer" class="flex justify-around">
                    <sl-button @click=${() => dialogRef.current && dialogRef.current.hide()}>ì·¨ì†Œ</sl-button>
                    <sl-button variant="danger" @click=${deleteConfirmed}>ì‚­ì œ</sl-button>
                </div>
            </sl-dialog>
        `;
    }

    // Initialize Thymeleaf template variables if needed
    const thymeleafData = /*[[${yourData}]]*/ null;

    // Render the app
    document.addEventListener('DOMContentLoaded', () => {
        render(h(TodoApp, {}), document.getElementById('app'));
    });
</script>
</body>
</html>