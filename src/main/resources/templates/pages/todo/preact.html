<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Todo List - HTML First</title>

    <link href="/libs/tailwind/tailwind.min.css" rel="stylesheet">
    <script src="/libs/axios/axios.min.js"></script>
    <script src="/libs/exceljs/exceljs.min.js"></script>

    <style>
        html { scroll-behavior: smooth; }
        @keyframes fade-in {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
        .modal {
            background: rgba(0,0,0,0.5);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-100 to-white p-10">

<div id="app" class="max-w-5xl mx-auto space-y-10 animate-fade-in">
    <!-- 헤더 -->
    <div class="flex items-center justify-between">
        <h1 class="text-4xl font-extrabold text-slate-800 drop-shadow">📋 To-do List</h1>
        <button id="download-excel" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white shadow">
            📥 엑셀 다운로드
        </button>
    </div>

    <!-- 입력폼 -->
    <form id="todo-form" class="bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200 p-6 flex flex-wrap items-center gap-4">
        <input id="new-task" type="text" placeholder="New task..."
               class="flex-1 min-w-[180px] p-2 rounded-lg border" required />
        <input id="start-date" type="date" class="flex-1 min-w-[150px] p-2 rounded-lg border" />
        <input id="end-date" type="date" class="flex-1 min-w-[150px] p-2 rounded-lg border" />
        <button type="submit"
                class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white shadow">
            ➕ 추가
        </button>
    </form>

    <!-- To-do 리스트 -->
    <div class="overflow-x-auto bg-white rounded-3xl shadow-2xl ring-1 ring-slate-200">
        <table class="w-full text-sm table-auto">
            <thead class="bg-slate-100 text-slate-700">
            <tr>
                <th class="p-4 text-left">작업</th>
                <th class="p-4 text-center">시작일</th>
                <th class="p-4 text-center">마감일</th>
                <th class="p-4 text-center">상태</th>
                <th class="p-4 text-center">토글</th>
                <th class="p-4 text-center">삭제</th>
            </tr>
            </thead>
            <tbody id="todo-list">
            <!-- Todo items will be rendered here -->
            <tr>
                <td colspan="6" class="p-8 text-center text-slate-400">
                    📝 아직 등록된 작업이 없습니다.
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 삭제 모달 (explicitly hidden with !important) -->
<div id="delete-modal" class="fixed inset-0 items-center justify-center bg-black/40 hidden" style="display: none !important;">
    <div class="bg-white p-8 rounded-xl shadow-2xl space-y-6 w-80">
        <h2 class="text-xl font-bold text-center">삭제 확인</h2>
        <p class="text-center text-slate-600">정말 삭제하시겠습니까?</p>
        <div class="flex justify-around">
            <button id="cancel-delete" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded">
                취소
            </button>
            <button id="confirm-delete" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">
                삭제
            </button>
        </div>
    </div>
</div>

<script>
    // Simple state management
    const TodoApp = {
        // State
        todos: [],
        todoIdToDelete: null,

        // Initialize the application
        init() {
            // Make absolutely sure the modal is hidden on initialization
            const modal = document.getElementById('delete-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';

            this.fetchTodos();
            this.setupEventListeners();
        },

        // Setup event listeners
        setupEventListeners() {
            // Form submission
            document.getElementById('todo-form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.createTodo();
            });

            // Download Excel button
            document.getElementById('download-excel').addEventListener('click', () => {
                this.downloadExcel();
            });

            // Delete modal buttons
            document.getElementById('cancel-delete').addEventListener('click', () => {
                this.hideDeleteModal();
            });

            document.getElementById('confirm-delete').addEventListener('click', () => {
                this.deleteConfirmed();
            });
        },

        // Fetch todos from API
        async fetchTodos() {
            try {
                const response = await axios.get('/api/todos');
                this.todos = response.data;
                this.renderTodoList();
            } catch (error) {
                console.error('Error fetching todos:', error);
                this.showError('할 일 목록을 불러오는 데 실패했습니다.');
            }
        },

        // Create a new todo
        async createTodo() {
            const newTaskInput = document.getElementById('new-task');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            const newTask = newTaskInput.value.trim();
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!newTask) return;

            try {
                await axios.post('/api/todos', {
                    title: newTask,
                    startDate: startDate,
                    endDate: endDate
                });

                // Clear inputs
                newTaskInput.value = '';
                startDateInput.value = '';
                endDateInput.value = '';

                // Refresh the list
                await this.fetchTodos();
            } catch (error) {
                console.error('Error creating todo:', error);
                this.showError('할 일을 추가하는 데 실패했습니다.');
            }
        },

        // Toggle todo completion status
        async toggleTodo(id) {
            try {
                await axios.patch(`/api/todos/${id}/toggle`);
                await this.fetchTodos();
            } catch (error) {
                console.error('Error updating todo:', error);
                this.showError('할 일 상태를 변경하는 데 실패했습니다.');
            }
        },

        // Show delete confirmation modal
        showDeleteModal(id) {
            this.todoIdToDelete = id;
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        },

        // Hide delete confirmation modal
        hideDeleteModal() {
            this.todoIdToDelete = null;
            const modal = document.getElementById('delete-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        },

        // Delete a todo after confirmation
        async deleteConfirmed() {
            if (this.todoIdToDelete === null) return;

            try {
                await axios.delete(`/api/todos/${this.todoIdToDelete}`);
                this.hideDeleteModal();
                await this.fetchTodos();
            } catch (error) {
                console.error('Error deleting todo:', error);
                this.showError('할 일을 삭제하는 데 실패했습니다.');
                this.hideDeleteModal();
            }
        },

        // Download todos as Excel file
        downloadExcel() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Todos');

            worksheet.columns = [
                { header: '작업', key: 'title' },
                { header: '시작일', key: 'startDate' },
                { header: '마감일', key: 'endDate' },
                { header: '상태', key: 'status' }
            ];

            this.todos.forEach(todo => worksheet.addRow({
                title: todo.title,
                startDate: todo.startDate || '-',
                endDate: todo.endDate || '-',
                status: todo.completed ? '완료' : '진행 중'
            }));

            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'todo-list.xlsx';
                a.click();
                URL.revokeObjectURL(url);
            }).catch(error => {
                console.error('Error creating Excel file:', error);
                this.showError('엑셀 파일 생성에 실패했습니다.');
            });
        },

        // Render the todo list
        renderTodoList() {
            const todoListEl = document.getElementById('todo-list');

            // Clear current list
            todoListEl.innerHTML = '';

            // Show message if no todos
            if (this.todos.length === 0) {
                todoListEl.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-8 text-center text-slate-400">
                            📝 아직 등록된 작업이 없습니다.
                        </td>
                    </tr>
                `;
                return;
            }

            // Add each todo item
            this.todos.forEach(todo => {
                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-slate-50 transition';

                // Create todo item content
                row.innerHTML = `
                    <td class="p-4 ${todo.completed ? 'line-through text-gray-400' : ''}">${todo.title}</td>
                    <td class="p-4 text-center">${todo.startDate || '-'}</td>
                    <td class="p-4 text-center">${todo.endDate || '-'}</td>
                    <td class="p-4 text-center">
                        <span class="${todo.completed ? 'text-green-600' : 'text-yellow-500'}">
                            ${todo.completed ? '완료' : '진행 중'}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} data-id="${todo.id}" class="toggle-todo" />
                    </td>
                    <td class="p-4 text-center">
                        <button data-id="${todo.id}" class="delete-todo text-red-500 hover:underline">
                            🗑️
                        </button>
                    </td>
                `;

                todoListEl.appendChild(row);
            });

            // Add event listeners to the new elements
            document.querySelectorAll('.toggle-todo').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    this.toggleTodo(e.target.dataset.id);
                });
            });

            document.querySelectorAll('.delete-todo').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    this.showDeleteModal(id);
                });
            });
        },

        // Show error message
        showError(message) {
            alert(message); // Simple error display for now
        }
    };

    // Initialize the application when the DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        TodoApp.init();
    });
</script>

</body>
</html>