<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List - Vue3 & Vuetify3</title>

    <!-- Vuetify 3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.css" rel="stylesheet">

    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">

    <!-- Vue 3 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>

    <!-- Vuetify 3 -->
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.0/dist/vuetify.min.js"></script>

    <!-- ExcelJS -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

    <style>
        [v-cloak] {
            display: none;
        }

        html {
            scroll-behavior: smooth;
            overflow-y: auto;
        }

        @keyframes fade-in {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
    </style>
</head>

<body>
<div id="app" v-cloak>
    <v-app>
        <v-main>
            <v-container class="py-8">
                <div class="animate-fade-in">
                    <!-- Ìó§Îçî -->
                    <v-row align="center" class="mb-6">
                        <v-col cols="auto">
                            <h1 class="text-h4 font-weight-bold">üìã To-do List</h1>
                        </v-col>
                        <v-spacer></v-spacer>
                        <v-col cols="auto">
                            <v-btn
                                    color="success"
                                    prepend-icon="mdi-download"
                                    @click="downloadExcel"
                            >
                                ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
                            </v-btn>
                        </v-col>
                    </v-row>

                    <!-- ÏûÖÎ†•Ìèº -->
                    <v-card class="mb-6 rounded-lg pa-4" elevation="3">
                        <v-form @submit.prevent="createTodo">
                            <v-row align="center">
                                <v-col cols="12" md="4">
                                    <v-text-field
                                            v-model.trim="newTask"
                                            label="New task..."
                                            variant="outlined"
                                            density="comfortable"
                                            required
                                    ></v-text-field>
                                </v-col>
                                <v-col cols="12" md="3">
                                    <v-text-field
                                            v-model="startDate"
                                            label="ÏãúÏûëÏùº"
                                            type="date"
                                            variant="outlined"
                                            density="comfortable"
                                    ></v-text-field>
                                </v-col>
                                <v-col cols="12" md="3">
                                    <v-text-field
                                            v-model="endDate"
                                            label="ÎßàÍ∞êÏùº"
                                            type="date"
                                            variant="outlined"
                                            density="comfortable"
                                    ></v-text-field>
                                </v-col>
                                <v-col cols="12" md="2">
                                    <v-btn
                                            type="submit"
                                            color="primary"
                                            block
                                            prepend-icon="mdi-plus"
                                            :disabled="!newTask.length"
                                    >
                                        Ï∂îÍ∞Ä
                                    </v-btn>
                                </v-col>
                            </v-row>
                        </v-form>
                    </v-card>

                    <!-- To-do Î¶¨Ïä§Ìä∏ -->
                    <v-card elevation="3" class="rounded-lg">
                        <v-data-table
                                :headers="headers"
                                :items="todos"
                                :items-per-page="10"
                                class="elevation-1"
                        >
                            <template v-slot:item.title="{ item }">
                                    <span :class="{ 'text-decoration-line-through': item.completed }">
                                        {{ item.title }}
                                    </span>
                            </template>

                            <template v-slot:item.startDate="{ item }">
                                {{ item.startDate || '-' }}
                            </template>

                            <template v-slot:item.endDate="{ item }">
                                {{ item.endDate || '-' }}
                            </template>

                            <template v-slot:item.status="{ item }">
                                <v-chip
                                        :color="item.completed ? 'success' : 'warning'"
                                        size="small"
                                        text-color="white"
                                >
                                    {{ item.completed ? 'ÏôÑÎ£å' : 'ÏßÑÌñâ Ï§ë' }}
                                </v-chip>
                            </template>

                            <template v-slot:item.toggle="{ item }">
                                <v-checkbox
                                        v-model="item.completed"
                                        @change="updateTodo(item.id)"
                                        hide-details
                                        density="compact"
                                ></v-checkbox>
                            </template>

                            <template v-slot:item.delete="{ item }">
                                <v-btn
                                        icon="mdi-delete"
                                        variant="text"
                                        color="error"
                                        density="compact"
                                        @click="todoIdToDelete = item.id"
                                ></v-btn>
                            </template>

                            <template v-slot:no-data>
                                <div class="text-center pa-5 text-grey">
                                    üìù ÏïÑÏßÅ Îì±Î°ùÎêú ÏûëÏóÖÏù¥ ÏóÜÏäµÎãàÎã§.
                                </div>
                            </template>
                        </v-data-table>
                    </v-card>
                </div>
            </v-container>
        </v-main>
    </v-app>

    <!-- ÏÇ≠Ï†ú ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
    <v-dialog v-model="deleteDialog" max-width="400">
        <v-card>
            <v-card-title class="text-center">ÏÇ≠Ï†ú ÌôïÏù∏</v-card-title>
            <v-card-text class="text-center">Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</v-card-text>
            <v-card-actions class="justify-center pb-6">
                <v-btn variant="outlined" @click="closeDeleteDialog">Ï∑®ÏÜå</v-btn>
                <v-btn color="error" class="ml-4" @click="deleteConfirmed">ÏÇ≠Ï†ú</v-btn>
            </v-card-actions>
        </v-card>
    </v-dialog>
</div>

<script th:inline="javascript">
    const { createApp, ref, computed } = Vue;

    const app = createApp({
        setup() {
            const todos = ref([]);
            const newTask = ref('');
            const startDate = ref('');
            const endDate = ref('');
            const todoIdToDelete = ref(null);

            const deleteDialog = computed(() => todoIdToDelete.value !== null);

            const headers = [
                { title: 'ÏûëÏóÖ', key: 'title', align: 'start' },
                { title: 'ÏãúÏûëÏùº', key: 'startDate', align: 'center' },
                { title: 'ÎßàÍ∞êÏùº', key: 'endDate', align: 'center' },
                { title: 'ÏÉÅÌÉú', key: 'status', align: 'center' },
                { title: 'ÌÜ†Í∏Ä', key: 'toggle', align: 'center', sortable: false },
                { title: 'ÏÇ≠Ï†ú', key: 'delete', align: 'center', sortable: false }
            ];

            const fetchTodos = async () => {
                try {
                    const res = await fetch('/api/todos');
                    if (res.ok) todos.value = await res.json();
                } catch (error) {
                    console.error('Todo Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
                }
            };

            const createTodo = async () => {
                if (!newTask.value.trim()) return;

                try {
                    const res = await fetch('/api/todos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: newTask.value,
                            startDate: startDate.value,
                            endDate: endDate.value
                        })
                    });

                    if (res.ok) {
                        newTask.value = '';
                        startDate.value = '';
                        endDate.value = '';
                        await fetchTodos();
                    }
                } catch (error) {
                    console.error('Todo ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
                }
            };

            const updateTodo = async (id) => {
                try {
                    const res = await fetch(`/api/todos/${id}/toggle`, { method: 'PATCH' });
                    if (res.ok) await fetchTodos();
                } catch (error) {
                    console.error('Todo ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
                }
            };

            const closeDeleteDialog = () => {
                todoIdToDelete.value = null;
            };

            const deleteConfirmed = async () => {
                try {
                    const res = await fetch(`/api/todos/${todoIdToDelete.value}`, { method: 'DELETE' });
                    if (res.ok) {
                        await fetchTodos();
                        closeDeleteDialog();
                    }
                } catch (error) {
                    console.error('Todo ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
                }
            };

            const downloadExcel = () => {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Todos');

                worksheet.columns = [
                    { header: 'ÏûëÏóÖ', key: 'title', width: 30 },
                    { header: 'ÏãúÏûëÏùº', key: 'startDate', width: 15 },
                    { header: 'ÎßàÍ∞êÏùº', key: 'endDate', width: 15 },
                    { header: 'ÏÉÅÌÉú', key: 'status', width: 10 }
                ];

                todos.value.forEach(todo => worksheet.addRow({
                    title: todo.title,
                    startDate: todo.startDate || '-',
                    endDate: todo.endDate || '-',
                    status: todo.completed ? 'ÏôÑÎ£å' : 'ÏßÑÌñâ Ï§ë'
                }));

                // Ïä§ÌÉÄÏùº Ï†ÅÏö©
                worksheet.getRow(1).font = { bold: true };

                workbook.xlsx.writeBuffer().then(buffer => {
                    const blob = new Blob([buffer], {
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'todo-list.xlsx';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            };

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Todo Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
            fetchTodos();

            return {
                todos,
                newTask,
                startDate,
                endDate,
                todoIdToDelete,
                headers,
                deleteDialog,
                createTodo,
                updateTodo,
                closeDeleteDialog,
                deleteConfirmed,
                downloadExcel
            };
        }
    });

    // Vuetify ÌîåÎü¨Í∑∏Ïù∏ ÏÇ¨Ïö©
    app.use(Vuetify.createVuetify({
        theme: {
            defaultTheme: 'light'
        }
    }));

    app.mount('#app');
</script>
</body>
</html>